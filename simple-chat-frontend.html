<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyAirtable AI Assistant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        .header {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .header h1 {
            color: white;
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .header p {
            color: rgba(255, 255, 255, 0.8);
            margin-top: 0.5rem;
        }
        
        .container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 2rem;
            gap: 2rem;
            width: 100%;
        }
        
        .chat-container {
            flex: 2;
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            display: flex;
            flex-direction: column;
            height: 600px;
        }
        
        .chat-header {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 80%;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message.assistant {
            align-self: flex-start;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
        }
        
        .message.user .message-avatar {
            background: #3b82f6;
            color: white;
        }
        
        .message.assistant .message-avatar {
            background: #f3f4f6;
            color: #374151;
        }
        
        .message-content {
            background: #f9fafb;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .message.user .message-content {
            background: #3b82f6;
            color: white;
            border-color: #3b82f6;
        }
        
        .message.assistant .message-content {
            background: white;
            border-color: #d1d5db;
        }
        
        .chat-input {
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }
        
        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .input-field {
            flex: 1;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            padding: 0.75rem;
            font-size: 1rem;
            resize: none;
            max-height: 120px;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .send-button {
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .send-button:hover:not(:disabled) {
            background: #2563eb;
        }
        
        .send-button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .sidebar {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }
        
        .info-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        
        .info-card h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #1f2937;
        }
        
        .example-prompt {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 0.5rem 0.75rem;
            margin: 0.25rem 0;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.875rem;
        }
        
        .example-prompt:hover {
            background: #f3f4f6;
            border-color: #3b82f6;
        }
        
        .status-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .status-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.875rem;
        }
        
        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 500;
        }
        
        .status-online {
            background: #dcfce7;
            color: #166534;
        }
        
        .status-ready {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-style: italic;
            padding: 0.5rem;
        }
        
        .typing-dots {
            display: flex;
            gap: 2px;
        }
        
        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #6b7280;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                order: -1;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ðŸ¤– PyAirtable AI Assistant</h1>
        <p>Ask questions about your Airtable data, create formulas, and get AI-powered insights</p>
    </div>
    
    <div class="container">
        <div class="chat-container">
            <div class="chat-header">
                <div class="status-indicator"></div>
                <h2>Chat Assistant</h2>
            </div>
            
            <div class="chat-messages" id="chatMessages">
                <div class="message assistant">
                    <div class="message-avatar">AI</div>
                    <div class="message-content">
                        Hello! I'm your PyAirtable AI assistant. I can help you analyze your Airtable data, create formulas, and provide insights. What would you like to know?
                    </div>
                </div>
            </div>
            
            <div class="typing-indicator" id="typingIndicator">
                <div class="message-avatar">AI</div>
                <span>Assistant is typing</span>
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
            
            <div class="chat-input">
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="input-field" 
                        placeholder="Ask about your data, request a formula, or get insights..."
                        rows="1"
                    ></textarea>
                    <button id="sendButton" class="send-button">Send</button>
                </div>
            </div>
        </div>
        
        <div class="sidebar">
            <div class="info-card">
                <h3>ðŸ’¡ Try These Examples</h3>
                <div class="example-prompt" onclick="setMessage('Analyze my Facebook posts table')">
                    "Analyze my Facebook posts table"
                </div>
                <div class="example-prompt" onclick="setMessage('Show me the top 10 posts by engagement')">
                    "Show me the top 10 posts by engagement"
                </div>
                <div class="example-prompt" onclick="setMessage('Create a formula to calculate ROI')">
                    "Create a formula to calculate ROI"
                </div>
                <div class="example-prompt" onclick="setMessage('What are my highest performing posts this month?')">
                    "What are my highest performing posts this month?"
                </div>
                <div class="example-prompt" onclick="setMessage('Help me set up an automation for new leads')">
                    "Help me set up an automation for new leads"
                </div>
            </div>
            
            <div class="info-card">
                <h3>ðŸš€ System Status</h3>
                <div class="status-list">
                    <div class="status-item">
                        <span>API Gateway</span>
                        <span class="status-badge status-online">Online</span>
                    </div>
                    <div class="status-item">
                        <span>LLM Orchestrator</span>
                        <span class="status-badge status-ready">Ready</span>
                    </div>
                    <div class="status-item">
                        <span>Airtable Gateway</span>
                        <span class="status-badge status-online">Connected</span>
                    </div>
                    <div class="status-item">
                        <span>MCP Server</span>
                        <span class="status-badge status-ready">Active</span>
                    </div>
                </div>
            </div>
            
            <div class="info-card">
                <h3>ðŸ’¡ Pro Tips</h3>
                <ul style="padding-left: 1rem; color: #6b7280; font-size: 0.875rem; line-height: 1.5;">
                    <li>Be specific about which table or view you're asking about</li>
                    <li>Ask follow-up questions to refine your analysis</li>
                    <li>Request explanations of formulas and automations</li>
                    <li>Use natural language - no need for technical jargon</li>
                </ul>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const API_BASE_URL = 'http://localhost:8000';
        const API_KEY = 'pya_d7f8e9a0b1c2d3e4f5a6b7c8d9e0f1a2b3c4d5e6';
        
        // DOM elements
        const chatMessages = document.getElementById('chatMessages');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const typingIndicator = document.getElementById('typingIndicator');
        
        // Auto-resize textarea
        messageInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = this.scrollHeight + 'px';
        });
        
        // Send message on Enter (but not Shift+Enter)
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // Send button click
        sendButton.addEventListener('click', sendMessage);
        
        // Set message from example
        function setMessage(text) {
            messageInput.value = text;
            messageInput.focus();
        }
        
        // Add message to chat
        function addMessage(content, sender = 'user') {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender === 'user' ? 'You' : 'AI'}</div>
                <div class="message-content">${content}</div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Show/hide typing indicator
        function showTyping(show = true) {
            typingIndicator.style.display = show ? 'flex' : 'none';
            if (show) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        }
        
        // Send message to backend
        async function sendMessage() {
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Disable input
            messageInput.disabled = true;
            sendButton.disabled = true;
            
            // Add user message
            addMessage(message, 'user');
            messageInput.value = '';
            messageInput.style.height = 'auto';
            
            // Show typing indicator
            showTyping(true);
            
            try {
                // Call the correct chat endpoint with proper format and authentication
                const response = await fetch(`${API_BASE_URL}/api/chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': API_KEY
                    },
                    body: JSON.stringify({
                        messages: [
                            {
                                role: 'user',
                                content: message
                            }
                        ],
                        session_id: 'demo-session-' + Date.now()
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showTyping(false);
                    addMessage(data.response || data.message || 'Response received successfully!', 'assistant');
                } else {
                    // Fallback: try different endpoints
                    const fallbackResponse = await tryFallbackEndpoints(message);
                    showTyping(false);
                    addMessage(fallbackResponse, 'assistant');
                }
            } catch (error) {
                console.error('Error sending message:', error);
                showTyping(false);
                addMessage('Sorry, I encountered an error. The backend services might be starting up. Please try again in a moment.', 'assistant');
            }
            
            // Re-enable input
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
        
        // Try different endpoints as fallbacks
        async function tryFallbackEndpoints(message) {
            const endpoints = [
                '/api/v1/llm/chat',
                '/api/v1/mcp/query',
                '/api/v1/airtable/analyze',
                '/health'
            ];
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            query: message,
                            message: message,
                            input: message
                        })
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        return `Connected to ${endpoint}! Response: ${JSON.stringify(data, null, 2)}`;
                    }
                } catch (error) {
                    console.log(`Endpoint ${endpoint} failed:`, error);
                }
            }
            
            // If all endpoints fail, return a helpful message
            return `I'm having trouble connecting to the backend services. Here's what I would help you with:

â€¢ **Data Analysis**: I can analyze your Airtable tables and provide insights about trends, patterns, and key metrics.
â€¢ **Formula Creation**: I can help you create complex formulas for calculations, data transformations, and automated fields.
â€¢ **Automation Ideas**: I can suggest workflows and automations to streamline your processes.
â€¢ **Report Generation**: I can help you create summaries and reports based on your data.

The backend services (API Gateway on port 8000, LLM Orchestrator on port 8003, MCP Server on port 8001, and Airtable Gateway on port 8002) should be running. Please check the logs or try again in a moment.`;
        }
        
        // Check backend health on load
        async function checkBackendHealth() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/health`);
                if (response.ok) {
                    console.log('Backend is healthy');
                } else {
                    console.log('Backend health check failed');
                }
            } catch (error) {
                console.log('Backend not responding:', error);
                addMessage('Note: Backend services may still be starting up. You can still explore the interface!', 'assistant');
            }
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            messageInput.focus();
            checkBackendHealth();
        });
    </script>
</body>
</html>