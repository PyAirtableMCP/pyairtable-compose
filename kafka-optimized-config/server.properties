# Optimized Kafka Server Configuration for High Performance
# PyAirtable Production Environment

# Basic Configuration
broker.id=1
listeners=PLAINTEXT://0.0.0.0:9092,SSL://0.0.0.0:9093
advertised.listeners=PLAINTEXT://kafka:9092,SSL://kafka:9093
num.network.threads=8
num.io.threads=16

# Socket Server Settings (Performance Optimized)
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
num.replica.fetchers=4

# Log Configuration (High Performance)
log.dirs=/kafka-logs
num.partitions=12
default.replication.factor=3
min.insync.replicas=2
log.retention.hours=168
log.retention.bytes=1073741824
log.segment.bytes=1073741824
log.retention.check.interval.ms=300000
log.cleanup.policy=delete

# Performance Tuning
log.flush.interval.messages=10000
log.flush.interval.ms=1000
log.flush.offset.checkpoint.interval.ms=60000
log.flush.scheduler.interval.ms=3000

# Network Performance
fetch.purgatory.purge.interval.requests=1000
producer.purgatory.purge.interval.requests=1000
replica.fetch.max.bytes=1048576
message.max.bytes=1048576
replica.fetch.response.max.bytes=10485760

# Producer Optimization
compression.type=lz4
batch.size=65536
linger.ms=10
buffer.memory=134217728
max.request.size=1048576

# Consumer Optimization
fetch.min.bytes=1024
fetch.max.wait.ms=500
max.poll.records=500
session.timeout.ms=30000
heartbeat.interval.ms=3000

# Topic Management
auto.create.topics.enable=false
delete.topic.enable=true
controlled.shutdown.enable=true
controlled.shutdown.max.retries=3
controlled.shutdown.retry.backoff.ms=5000

# Replication Configuration
replica.lag.time.max.ms=30000
replica.socket.timeout.ms=30000
replica.socket.receive.buffer.bytes=65536
replica.fetch.max.bytes=1048576
replica.fetch.wait.max.ms=500
replica.high.watermark.checkpoint.interval.ms=5000
replica.fetch.backoff.ms=1000

# Group Coordination
group.initial.rebalance.delay.ms=3000
group.max.session.timeout.ms=1800000
group.min.session.timeout.ms=6000

# Security Configuration
security.inter.broker.protocol=PLAINTEXT
ssl.keystore.location=/etc/kafka/ssl/kafka.server.keystore.jks
ssl.keystore.password=kafka-keystore-password
ssl.key.password=kafka-key-password
ssl.truststore.location=/etc/kafka/ssl/kafka.server.truststore.jks
ssl.truststore.password=kafka-truststore-password
ssl.client.auth=required
ssl.enabled.protocols=TLSv1.2
ssl.keystore.type=JKS
ssl.truststore.type=JKS

# Metrics and Monitoring
metric.reporters=org.apache.kafka.common.metrics.JmxReporter
auto.include.jmx.reporter=true
jmx.port=9999

# Background Threads Optimization
background.threads=10
log.cleaner.threads=2
log.cleaner.io.max.bytes.per.second=1048576
log.cleaner.dedupe.buffer.size=134217728
log.cleaner.io.buffer.size=524288
log.cleaner.io.buffer.load.factor=0.9
log.cleaner.backoff.ms=15000

# Transaction Coordination (for exactly-once semantics)
transaction.state.log.replication.factor=3
transaction.state.log.min.isr=2
transaction.state.log.num.partitions=50
transactional.id.expiration.ms=604800000

# Leader Election
unclean.leader.election.enable=false
leader.imbalance.per.broker.percentage=10
leader.imbalance.check.interval.seconds=300

# Request Processing
queued.max.requests=500
request.timeout.ms=30000
connections.max.idle.ms=600000
max.connections.per.ip=0
max.connections.per.ip.overrides=

# Memory and Buffer Management
socket.send.buffer.bytes=102400
socket.receive.buffer.bytes=102400
socket.request.max.bytes=104857600
receive.buffer.bytes=102400
send.buffer.bytes=102400

# Advanced Performance Settings
num.recovery.threads.per.data.dir=2
num.replica.alter.log.dirs.threads=2
log.message.format.version=3.0-IV1
inter.broker.protocol.version=3.0-IV1

# Quota Configuration
quota.consumer.default=2097152
quota.producer.default=2097152
quota.window.num=11
quota.window.size.seconds=1

# Additional JVM Settings (to be used in startup script)
# -Xms4g -Xmx4g
# -XX:+UseG1GC
# -XX:MaxGCPauseMillis=200
# -XX:InitiatingHeapOccupancyPercent=35
# -XX:+ExplicitGCInvokesConcurrent
# -XX:MaxInlineLevel=15
# -Djava.awt.headless=true
# -Dcom.sun.management.jmxremote
# -Dcom.sun.management.jmxremote.authenticate=false
# -Dcom.sun.management.jmxremote.ssl=false
# -Dcom.sun.management.jmxremote.port=9999