# Optimized Mimir Configuration for PyAirtable LGTM Stack
# Focus: Long-term metrics storage, cost optimization, resource efficiency

# Target: all services running in single binary mode for resource efficiency
target: all

# Server configuration
server:
  http_listen_port: 8080
  grpc_listen_port: 9095
  log_level: info
  log_format: logfmt

# Common configuration
common:
  storage:
    backend: s3
    s3:
      endpoint: minio:9000
      bucket_name: mimir-data
      access_key_id: minioadmin
      secret_access_key: minioadmin123
      insecure: true
      # Optimize for cost
      sse:
        type: ""
      # Reduce part size for memory optimization
      part_size: 134217728  # 128MB

# Blocks storage configuration
blocks_storage:
  # Backend configuration
  backend: s3
  s3:
    endpoint: minio:9000
    bucket_name: mimir-data
    access_key_id: minioadmin
    secret_access_key: minioadmin123
    insecure: true
  
  # TSDB configuration for resource optimization
  tsdb:
    dir: /data/tsdb
    # Reduce memory usage
    block_ranges_period: [ "2h", "12h", "24h" ]
    retention_period: 24h  # Keep only 24h locally, rest in object storage
    # Reduce WAL size
    wal_compression_enabled: true
    # Optimize head series
    head_compaction_interval: 4m
    head_compaction_concurrency: 5
    # Reduce memory usage
    head_series_head_chunk_write_queue_size: 10000
    
  # Bucket store configuration for querying historical data
  bucket_store:
    # Sync configuration
    sync_interval: 15m
    
    # Index cache configuration (in-memory)
    index_cache:
      backend: inmemory
      inmemory:
        max_size_bytes: 268435456  # 256MB
    
    # Chunks cache configuration
    chunks_cache:
      backend: inmemory
      inmemory:
        max_size_bytes: 268435456  # 256MB
    
    # Metadata cache configuration
    metadata_cache:
      backend: inmemory
      inmemory:
        max_size_bytes: 134217728  # 128MB
    
    # Index header lazy loading
    index_header_lazy_loading_enabled: true
    index_header_lazy_loading_idle_timeout: 20m

# Distributor configuration
distributor:
  # Pool configuration
  pool:
    health_check_ingesters: true
  
  # HA tracker (disabled for single instance)
  ha_tracker:
    enable_ha_tracker: false
  
  # Rate limiting
  ring:
    kvstore:
      store: inmemory

# Ingester configuration
ingester:
  # Ring configuration
  ring:
    # Instance configuration
    instance_addr: 127.0.0.1
    instance_port: 8080
    kvstore:
      store: inmemory
    replication_factor: 1
    # Reduce tokens for single instance
    num_tokens: 128
    # Lifecycle settings
    heartbeat_period: 5s
    heartbeat_timeout: 1m
    observe_period: 10s
    join_after: 10s
    min_ready_duration: 15s
    final_sleep: 30s
  
  # Instance limits for cost optimization
  instance_limits:
    max_inflight_push_requests: 30000
    max_ingestion_rate: 10000  # 10k samples/sec per ingester
    max_series: 1500000        # 1.5M series per ingester
    max_tenants: 1000          # Max tenants per ingester
    max_inflight_push_requests_bytes: 104857600  # 100MB

# Querier configuration
querier:
  # Query limits
  max_concurrent: 20
  timeout: 2m
  max_samples: 50000000
  default_evaluation_interval: 1m
  
  # Store gateway interaction
  store_gateway_addresses: "127.0.0.1:8080"

# Query frontend configuration
query_frontend:
  # Query result caching
  results_cache:
    backend: inmemory
    inmemory:
      max_size_bytes: 134217728  # 128MB
    compression: snappy
  
  # Query sharding
  parallelize_shardable_queries: true
  query_sharding_target_series_per_shard: 2500
  
  # Query splitting
  split_queries_by_interval: 24h
  cache_results: true
  max_retries: 2
  
  # Slow query log
  log_queries_longer_than: 10s

# Ruler configuration for alerting
ruler:
  # Enable ruler API
  enable_api: true
  
  # Storage configuration
  rule_path: /data/rules
  
  # Alert manager configuration
  alertmanager_url: http://alertmanager:9093
  
  # Evaluation configuration
  evaluation_interval: 15s
  poll_interval: 1m
  
  # Query configuration
  query_timeout: 1m
  max_rule_groups_per_tenant: 20
  max_rules_per_rule_group: 20
  
  # Ring configuration
  ring:
    kvstore:
      store: inmemory

# Alertmanager configuration (basic)
alertmanager:
  # Enable Alertmanager
  enable_api: true
  
  # Data directory
  data_dir: /data/alertmanager
  
  # Retention
  retention: 120h  # 5 days
  
  # External configuration
  external_url: http://alertmanager:9093
  
  # Fallback configuration
  fallback_config_file: /etc/alertmanager/fallback_config.yml

# Compactor configuration
compactor:
  # Data directory
  data_dir: /data/compactor
  
  # Compaction configuration
  compaction_interval: 1h
  deletion_delay: 2h
  max_closing_blocks_concurrency: 2
  max_opening_blocks_concurrency: 4
  
  # Block ranges
  block_ranges: [ "2h", "12h", "24h" ]
  
  # Tenant cleanup
  tenant_cleanup_delay: 6h
  
  # Ring configuration
  ring:
    kvstore:
      store: inmemory

# Store gateway configuration
store_gateway:
  # Sharding strategy
  sharding_enabled: false  # Disabled for single instance
  
  # Bucket store configuration (inherits from blocks_storage.bucket_store)
  
  # Ring configuration
  ring:
    kvstore:
      store: inmemory

# Overrides for cost and resource optimization
overrides:
  # Default limits per tenant
  ingestion_rate: 10000           # 10k samples/sec per tenant
  ingestion_burst_size: 200000    # 200k burst samples
  max_series_per_user: 1000000    # 1M series per tenant
  max_series_per_metric: 50000    # 50k series per metric
  max_global_series_per_user: 1000000
  max_global_series_per_metric: 50000
  
  # Query limits
  max_samples_per_query: 1000000  # 1M samples per query
  max_series_per_query: 100000    # 100k series per query
  max_chunks_per_query: 2000000   # 2M chunks per query
  max_query_length: 7776000s      # 90 days max query range
  max_query_parallelism: 14
  max_cache_freshness: 1m
  
  # Cardinality limits
  max_label_name_length: 1024
  max_label_value_length: 4096
  max_label_names_per_series: 30
  max_metadata_length: 1024
  
  # Compaction
  compactor_blocks_retention_period: 2160h  # 90 days retention
  
  # Out of order samples (enable for better data ingestion)
  out_of_order_time_window: 1m
  
  # Native histograms (disable to save resources initially)
  native_histograms_ingestion_enabled: false

# Activity tracker (disable to save resources)
activity_tracker:
  filepath: ""

# Usage stats (disable for privacy)
usage_stats:
  enabled: false

# Runtime configuration
runtime_config:
  file: ""

# Memberlist (for clustering - minimal config for single instance)
memberlist:
  abort_if_cluster_join_fails: false
  bind_port: 7946
  join_members: []

# Multi-tenancy (disabled for simplicity)
multitenancy_enabled: false

# No authentication for internal setup
no_auth_tenant: anonymous

# Limits (for resource management)
limits:
  # Native histograms
  native_histograms_ingestion_enabled: false
  
  # Reduce memory usage
  max_outstanding_requests_per_tenant: 100
  
  # Request rate limits
  request_rate: 0  # No rate limiting
  request_burst_size: 0