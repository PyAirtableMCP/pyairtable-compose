# Tempo Production Configuration
# Optimized for production distributed tracing with S3 storage,
# enhanced retention policies, and high-performance query capabilities

server:
  http_listen_port: 3200
  log_level: warn
  log_format: json

distributor:
  receivers:
    jaeger:
      protocols:
        thrift_http:
          endpoint: 0.0.0.0:14268
        grpc:
          endpoint: 0.0.0.0:14250
    otlp:
      protocols:
        grpc:
          endpoint: 0.0.0.0:4317
        http:
          endpoint: 0.0.0.0:4318
    opencensus:
    zipkin:

ingester:
  trace_idle_period: 10s
  max_block_bytes: 1_000_000
  max_block_duration: 5m
  complete_block_timeout: 15m
  flush_check_period: 10s
  lifecycler:
    ring:
      kvstore:
        store: inmemory
      replication_factor: 1

compactor:
  compaction:
    compaction_window: 1h
    max_block_bytes: 100_000_000
    block_retention: 24h  # 1 day retention for blocks
    compacted_block_retention: 1h
  ring:
    kvstore:
      store: inmemory

querier:
  max_concurrent_queries: 20
  search:
    default_result_limit: 20
    max_result_limit: 100
  trace_by_id:
    query_timeout: 10s

query_frontend:
  max_outstanding_per_tenant: 2000
  search:
    duration_slo: 5s
    throughput_bytes_slo: 1.073741824e+09
    default_result_limit: 20
    max_result_limit: 100
    max_duration: 0s
    query_backend_after: 0s
    query_ingesters_until: 15m
    concurrent_jobs: 1000
    target_bytes_per_job: 104857600
  trace_by_id:
    query_shards: 50
    hedge_requests_at: 2s
    hedge_requests_up_to: 2

storage:
  trace:
    backend: s3
    s3:
      endpoint: minio:9000
      bucket: tempo-data
      access_key: ${MINIO_ROOT_USER:-pyairtable_admin}
      secret_key: ${MINIO_ROOT_PASSWORD:-PyAirtable2025!}
      insecure: true
    wal:
      path: /var/tempo/wal
    local:
      path: /var/tempo/blocks
    pool:
      max_workers: 100
      queue_depth: 10000

memberlist:
  node_name: tempo
  randomize_node_name: false
  stream_timeout: 10s
  retransmit_factor: 4
  pull_push_interval: 30s
  gossip_interval: 200ms
  gossip_nodes: 3
  gossip_to_dead_time: 30s
  left_ingesters_timeout: 5m
  bind_addr:
    - 0.0.0.0
  bind_port: 7946

overrides:
  defaults:
    # Global limits
    max_traces_per_user: 0
    max_bytes_per_trace: 50000000  # 50MB
    max_bytes_per_tag_values_query: 5000000  # 5MB
    
    # Ingestion limits
    ingestion_rate_limit_bytes: 15000000  # 15MB/s
    ingestion_burst_size_bytes: 20000000  # 20MB
    
    # Query limits
    max_search_bytes_per_trace: 0
    max_search_duration: 0s
    
    # Forwarders
    forwarders: []
    
    # Metrics generator
    metrics_generator:
      # Disable by default for production
      processor:
        span_metrics:
          enable: false
        service_graphs:
          enable: false
      registry:
        external_labels: {}
  
  per_tenant_override_config: /conf/overrides.yaml

metrics_generator:
  # Metrics generation from traces (optional)
  registry:
    external_labels:
      source: tempo
      cluster: production
      replica: ${HOSTNAME}
  storage:
    path: /var/tempo/generator/wal
    remote_write:
      - url: http://mimir:8080/api/v1/push
        send_exemplars: true
        headers:
          X-Scope-OrgID: pyairtable
  processor:
    # Service graphs processor
    service_graphs:
      histogram_buckets: [0.1, 0.2, 0.4, 0.8, 1.6, 3.2, 6.4, 12.8]
      dimensions: [service.name, span.name, span.kind, status.code]
      peer_attributes: [service.name, service.namespace, service.instance.id]
      enable_client_server_prefix: true

    # Span metrics processor  
    span_metrics:
      histogram_buckets: [0.002, 0.005, 0.01, 0.025, 0.05, 0.075, 0.1, 0.25, 0.5, 0.75, 1.0, 2.5, 5.0, 7.5, 10.0]
      dimensions: [service.name, operation, span.kind, status.code]
      intrinsic_dimensions:
        service.name: true
        span.kind: true
        status.code: true

# Usage report (disable for production)
usage_report:
  reporting_enabled: false

# Global tags for all traces
global_tags:
  environment: production
  cluster: pyairtable